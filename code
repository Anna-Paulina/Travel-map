<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte de voyage – iPhone</title>

  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
      background: #fff;
    }

    h3 {
      margin: 8px;
      font-size: 16px;
    }

    #map {
      height: calc(100vh - 70px);
      width: 100%;
    }

    .leaflet-popup-content {
      margin: 8px;
      font-size: 14px;
    }

    .leaflet-popup-content img {
      width: 100%;
      border-radius: 10px;
      margin-top: 6px;
    }

    input[type="file"] {
      margin: 8px;
      font-size: 14px;
    }
  </style>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine -->
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
</head>

<body>

<h3>Importer un fichier CSV</h3>
<input type="file" id="csvFile" accept=".csv" />
<div id="map"></div>

<script>
/* ======================
   MAP INIT (iOS SAFE)
====================== */
const map = L.map("map", {
  zoomControl: false,
  tap: false,
  inertia: true
}).setView([20, -90], 5);

L.control.zoom({ position: "bottomright" }).addTo(map);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

/* ======================
   UNSPLASH API
====================== */
async function getUnsplashImage(query) {
  const ACCESS_KEY = "TA_CLE_UNSPLASH_ICI";
  const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=1&orientation=landscape&client_id=${ACCESS_KEY}`;

  const res = await fetch(url);
  const data = await res.json();

  if (data.results && data.results.length > 0) {
    return data.results[0].urls.small;
  }
  return null;
}

/* ======================
   CSV IMPORT
====================== */
document.getElementById("csvFile").addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: async function (results) {
      const waypoints = [];
      const bounds = [];

      for (const row of results.data) {
        const lat = parseFloat(row["Latitude"]);
        const lng = parseFloat(row["Longitude"]);
        const nom = row["Lieu"] || "Lieu";
        const jours = row["Jours sur place"] || "?";

        if (isNaN(lat) || isNaN(lng)) continue;

        const imageUrl = await getUnsplashImage(nom);

        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`
          <strong>${nom}</strong><br>
          Jours sur place : ${jours}<br>
          ${imageUrl ? `<img src="${imageUrl}">` : "Pas d'image"}
        `);

        waypoints.push(L.latLng(lat, lng));
        bounds.push([lat, lng]);
      }

      if (bounds.length) map.fitBounds(bounds);
      drawRouteSegments(waypoints);
    }
  });
});

/* ======================
   ROUTES SEGMENTÉES
====================== */
function drawRouteSegments(points) {
  let i = 0;

  function next() {
    if (i >= points.length - 1) return;

    const from = points[i];
    const to = points[i + 1];

    L.Routing.control({
      waypoints: [from, to],
      router: L.Routing.osrmv1({
        serviceUrl: "https://router.project-osrm.org/route/v1"
      }),
      lineOptions: {
        styles: [{ color: "#1976d2", weight: 5 }]
      },
      addWaypoints: false,
      draggableWaypoints: false,
      fitSelectedRoutes: false,
      show: false,
      createMarker: () => null
    })
    .on("routesfound", function (e) {
      const leg = e.routes[0].legs[0];

      this._line.on("click", evt => {
        L.popup()
          .setLatLng(evt.latlng)
          .setContent(`
            <strong>Étape ${i + 1} → ${i + 2}</strong><br>
            ${(leg.distance / 1000).toFixed(1)} km<br>
            ${(leg.time / 3600).toFixed(1)} h
          `)
          .openOn(map);
      });

      i++;
      setTimeout(next, 700);
    })
    .on("routingerror", function () {
      L.polyline([from, to], {
        color: "#e53935",
        weight: 4,
        dashArray: "6,6"
      }).addTo(map);

      i++;
      setTimeout(next, 700);
    })
    .addTo(map);
  }

  next();
}
</script>

</body>
</html>
