<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Carte de voyage</title>

  <!-- Mobile friendly (iPhone OK) -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Leaflet Routing Machine -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
  />

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .popup-img {
      width: 220px;
      border-radius: 10px;
      margin-top: 6px;
      object-fit: cover;
    }
  </style>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine -->
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
</head>

<body>
  <div id="map"></div>

<script>
/* ======================
   INIT MAP
====================== */
const map = L.map("map", {
  tap: false
}).setView([20, -90], 4);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

/* ======================
   LOAD CSV FROM GITHUB
====================== */
fetch("trip.csv")
  .then(res => {
    if (!res.ok) throw new Error("CSV introuvable");
    return res.text();
  })
  .then(csv => {
    Papa.parse(csv, {
      header: true,
      skipEmptyLines: true,
      complete: res => initMap(res.data)
    });
  })
  .catch(err => {
    alert("Erreur chargement CSV : " + err.message);
  });

/* ======================
   MAIN LOGIC
====================== */
function initMap(data) {
  const waypoints = [];
  const bounds = [];

  data.forEach(row => {
    const lat = parseFloat(row.Latitude);
    const lng = parseFloat(row.Longitude);
    if (isNaN(lat) || isNaN(lng)) return;

    const name = row.Lieu || "Lieu";
    const days = row["Jours sur place"] || "?";

    const imgUrl = `https://source.unsplash.com/400x300/?${encodeURIComponent(name)}`;

    const marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup(`
      <strong>${name}</strong><br>
      Jours sur place : ${days}<br>
      <img src="${imgUrl}" class="popup-img"
           onerror="this.src='https://picsum.photos/400/300'">
    `);

    const ll = L.latLng(lat, lng);
    waypoints.push(ll);
    bounds.push(ll);
  });

  if (bounds.length) map.fitBounds(bounds);

  drawSegments(waypoints);
}

/* ======================
   ROUTING SEGMENT BY SEGMENT
====================== */
function drawSegments(points) {
  let i = 0;

  function next() {
    if (i >= points.length - 1) return;

    const from = points[i];
    const to = points[i + 1];

    const control = L.Routing.control({
      waypoints: [from, to],
      router: L.Routing.osrmv1({
        serviceUrl: "https://router.project-osrm.org/route/v1"
      }),
      addWaypoints: false,
      draggableWaypoints: false,
      fitSelectedRoutes: false,
      show: false,
      createMarker: () => null,
      lineOptions: {
        styles: [{ color: "#1e88e5", weight: 5 }]
      }
    })
    .on("routesfound", e => {
      const leg = e.routes[0].legs[0];

      control._line.on("click", ev => {
        L.popup()
          .setLatLng(ev.latlng)
          .setContent(`
            <strong>Étape ${i + 1} → ${i + 2}</strong><br>
            Distance : ${(leg.distance / 1000).toFixed(1)} km<br>
            Durée : ${(leg.time / 3600).toFixed(1)} h
          `)
          .openOn(map);
      });

      i++;
      setTimeout(next, 700);
    })
    .on("routingerror", () => {
      const line = L.polyline([from, to], {
        color: "#e53935",
        weight: 4,
        dashArray: "6,6"
      }).addTo(map);

      const km = from.distanceTo(to) / 1000;

      line.on("click", ev => {
        L.popup()
          .setLatLng(ev.latlng)
          .setContent(`
            <strong>Étape ${i + 1} → ${i + 2}</strong><br>
            ⚠️ Route impossible<br>
            Distance estimée : ${km.toFixed(1)} km
          `)
          .openOn(map);
      });

      i++;
      setTimeout(next, 700);
    })
    .addTo(map);
  }

  next();
}
</script>
</body>
</html>
