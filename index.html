<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Travel Map - Test Images</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
}
#map {
  height: 90vh;
}
.popup-img {
  width: 100%;
  max-width: 300px;
  height: 200px;
  margin-top: 6px;
  border-radius: 8px;
  object-fit: cover;
  background: #e0e0e0;
  display: block;
  border: 2px solid #ccc;
}
.popup-content {
  min-width: 250px;
}
.loading-img {
  width: 100%;
  max-width: 300px;
  height: 200px;
  margin-top: 6px;
  border-radius: 8px;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #666;
  font-size: 14px;
}
@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.img-source {
  font-size: 10px;
  color: #888;
  margin-top: 4px;
}
.debug-info {
  font-size: 10px;
  color: #666;
  background: #f5f5f5;
  padding: 4px;
  margin-top: 4px;
  border-radius: 4px;
  font-family: monospace;
  word-break: break-all;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
</head>
<body>
<h3 style="padding:8px">üåç Travel Route - Test Images</h3>
<div id="map"></div>

<script>
const map = L.map("map").setView([15, -90], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

// ========================
// SIMPLE WORKING IMAGE SOURCES
// ========================
function getPlaceImage(placeName, lat, lng, index) {
  // Use multiple simple sources that DEFINITELY work
  const sources = [
    {
      name: 'Picsum (Random Photo)',
      url: `https://picsum.photos/400/300?random=${index}`,
      type: 'random'
    },
    {
      name: 'PlaceIMG',
      url: `https://placeimg.com/400/300/nature?t=${index}`,
      type: 'random'
    },
    {
      name: 'LoremFlickr',
      url: `https://loremflickr.com/400/300/landscape,nature?lock=${index}`,
      type: 'generic'
    },
    {
      name: 'Placeholder',
      url: `https://via.placeholder.com/400x300/4A90E2/FFFFFF?text=${encodeURIComponent(placeName.substring(0, 20))}`,
      type: 'placeholder'
    },
    {
      name: 'DummyImage',
      url: `https://dummyimage.com/400x300/4A90E2/fff&text=${encodeURIComponent(placeName.substring(0, 15))}`,
      type: 'placeholder'
    }
  ];
  
  // Return first option (we'll cycle through in error handler)
  return sources;
}

// ========================
// LOAD CSV
// ========================
Papa.parse("trip.csv", {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function(results) {
    const points = [];
    const bounds = [];
    
    results.data.forEach((row, idx) => {
      const lat = parseFloat(row.Latitude);
      const lng = parseFloat(row.Longitude);
      const name = row.Lieu || row.Place || "Unknown";
      const days = row["Jours sur place"] || row.Days || "N/A";
      
      if (isNaN(lat) || isNaN(lng)) return;
      
      const marker = L.marker([lat, lng]).addTo(map);
      
      // Create popup with loading placeholder
      const popupContent = `
        <div class="popup-content">
          <strong>${name}</strong><br>
          ‚è± ${days} jour(s)<br>
          <div class="loading-img">üì∏ Chargement...</div>
        </div>
      `;
      
      marker.bindPopup(popupContent, {
        maxWidth: 350
      });
      
      // Load image when popup is opened
      marker.on('popupopen', function(e) {
        const popup = e.popup;
        const sources = getPlaceImage(name, lat, lng, idx);
        let currentSourceIndex = 0;
        
        function tryNextSource() {
          if (currentSourceIndex >= sources.length) {
            // All sources failed - show error
            popup.setContent(`
              <div class="popup-content">
                <strong>${name}</strong><br>
                ‚è± ${days} jour(s)<br>
                <div style="padding:20px;background:#fee;color:#c33;border-radius:8px;margin-top:8px;">
                  ‚ùå Toutes les sources d'images ont √©chou√©
                </div>
              </div>
            `);
            return;
          }
          
          const source = sources[currentSourceIndex];
          console.log(`Trying source ${currentSourceIndex + 1}/${sources.length}: ${source.name}`);
          console.log(`URL: ${source.url}`);
          
          const imgId = `img-${idx}-${currentSourceIndex}`;
          
          popup.setContent(`
            <div class="popup-content">
              <strong>${name}</strong><br>
              ‚è± ${days} jour(s)<br>
              <img id="${imgId}" 
                   class="popup-img" 
                   src="${source.url}" 
                   alt="${name}"
                   crossorigin="anonymous">
              <div class="img-source">
                Source ${currentSourceIndex + 1}/${sources.length}: ${source.name}
              </div>
              <div class="debug-info">
                URL: ${source.url.substring(0, 60)}...
              </div>
            </div>
          `);
          
          // Wait for image to be in DOM
          setTimeout(() => {
            const img = document.getElementById(imgId);
            if (!img) {
              console.error('Image element not found in DOM');
              currentSourceIndex++;
              tryNextSource();
              return;
            }
            
            img.onload = function() {
              console.log(`‚úì SUCCESS! Image loaded from: ${source.name}`);
              // Update popup to remove debug info on success
              popup.setContent(`
                <div class="popup-content">
                  <strong>${name}</strong><br>
                  ‚è± ${days} jour(s)<br>
                  <img class="popup-img" 
                       src="${source.url}" 
                       alt="${name}">
                  <div class="img-source">‚úì ${source.name}</div>
                </div>
              `);
            };
            
            img.onerror = function() {
              console.error(`‚úó FAILED: ${source.name} - ${source.url}`);
              currentSourceIndex++;
              setTimeout(tryNextSource, 500);
            };
            
            // Timeout fallback
            setTimeout(() => {
              if (!img.complete || img.naturalWidth === 0) {
                console.warn(`Timeout on ${source.name}`);
                currentSourceIndex++;
                tryNextSource();
              }
            }, 5000);
            
          }, 100);
        }
        
        tryNextSource();
      });
      
      const ll = L.latLng(lat, lng);
      points.push(ll);
      bounds.push(ll);
    });
    
    if (bounds.length) map.fitBounds(bounds);
    
    if (points.length > 1) {
      drawRouteSegments(points);
    }
  }
});

// ========================
// ROUTING
// ========================
function drawRouteSegments(points) {
  let i = 0;
  
  function next() {
    if (i >= points.length - 1) return;
    
    const from = points[i];
    const to = points[i + 1];
    
    const routing = L.Routing.control({
      waypoints: [from, to],
      router: L.Routing.osrmv1({
        serviceUrl: "https://router.project-osrm.org/route/v1"
      }),
      addWaypoints: false,
      draggableWaypoints: false,
      fitSelectedRoutes: false,
      show: false,
      createMarker: () => null,
      lineOptions: {
        styles: [{
          color: '#1e88e5',
          opacity: 0.8,
          weight: 5
        }]
      }
    }).addTo(map);
    
    routing.on("routesfound", e => {
      const route = e.routes[0];
      const distance = route.summary ? route.summary.totalDistance : 0;
      const time = route.summary ? route.summary.totalTime : 0;
      
      const routeLine = routing._line;
      if (routeLine) {
        routeLine.on("click", ev => {
          L.popup()
            .setLatLng(ev.latlng)
            .setContent(`
              üöó <strong>Segment ${i+1}</strong><br>
              Distance: ${(distance / 1000).toFixed(1)} km<br>
              Dur√©e: ${(time / 3600).toFixed(1)} h
            `)
            .openOn(map);
        });
      }
      
      i++;
      setTimeout(next, 800);
    });
    
    routing.on("routingerror", (e) => {
      const line = L.polyline([from, to], {
        color: "#e53935",
        weight: 4,
        dashArray: "6,6",
        opacity: 0.7
      }).addTo(map);
      
      const km = from.distanceTo(to) / 1000;
      line.on("click", ev => {
        L.popup()
          .setLatLng(ev.latlng)
          .setContent(`
            ‚ö†Ô∏è Pas de route disponible<br>
            Distance (√† vol d'oiseau): ${km.toFixed(1)} km
          `)
          .openOn(map);
      });
      
      i++;
      setTimeout(next, 800);
    });
  }
  
  next();
}
</script>
</body>
</html>
